{% extends "base.html" %}

{% block title %}Dashboard - Kali Password Manager{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt text-glow"></i>
            <div>
                <h5 class="mb-0">Kali Password Manager</h5>
                <small>{{ session.user_email }}</small>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="active">
                <i class="fas fa-key"></i>
                Your Passwords
            </a>
            <a href="#" onclick="showSettings(); return false;">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="#" onclick="showAnalytics(); return false;">
                <i class="fas fa-chart-line"></i>
                Analytics
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <a href="{{ url_for('logout') }}" class="btn btn-outline-kali w-100">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div>
                <h2 class="mb-0">Password Dashboard</h2>
                <p class="text-secondary mb-0">Manage your secure passwords</p>
            </div>
            <button class="btn btn-kali" onclick="showAddPasswordModal()">
                <i class="fas fa-plus me-2"></i>Add Password
            </button>
        </div>
        
        <main class="content">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div id="passwordsList">
                        <div class="text-center py-5">
                            <i class="fas fa-key fa-3x mb-3" style="color: var(--kali-text-secondary);"></i>
                            <h4>Loading passwords...</h4>
                            <p class="text-secondary">Please wait while we fetch your passwords</p>
                        </div>
                    </div>
                    
                    <!-- Settings Section (Hidden by default) -->
                    <div id="settingsSection" style="display: none;">
                        <div class="password-card">
                            <h3 class="mb-4"><i class="fas fa-cog me-2"></i>Settings</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3">Security Settings</h5>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="twoFactorAuth">
                                        <label class="form-check-label text-secondary" for="twoFactorAuth">
                                            Enable Two-Factor Authentication
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="passwordExpiry" checked>
                                        <label class="form-check-label text-secondary" for="passwordExpiry">
                                            Password Expiry Notifications
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="mb-3">Account Settings</h5>
                                    <button class="btn btn-outline-kali mb-2 w-100">
                                        <i class="fas fa-download me-2"></i>Export Passwords
                                    </button>
                                    <button class="btn btn-outline-kali mb-2 w-100">
                                        <i class="fas fa-upload me-2"></i>Import Passwords
                                    </button>
                                    <button class="btn btn-outline-danger w-100">
                                        <i class="fas fa-trash me-2"></i>Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics Section (Hidden by default) -->
                    <div id="analyticsSection" style="display: none;">
                        <div class="password-card">
                            <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Analytics</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="mb-3 text-secondary">Password Strength Distribution</h5>
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar bg-danger" style="width: 20%">Weak: 20%</div>
                                        <div class="progress-bar bg-warning" style="width: 30%">Medium: 30%</div>
                                        <div class="progress-bar bg-success" style="width: 50%">Strong: 50%</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="mb-3 text-secondary">Most Used Websites</h5>
                                    <div class="list-group">
                                        <div class="list-group-item d-flex justify-content-between align-items-center" style="background: var(--kali-card-bg); border: 1px solid var(--kali-border); color: var(--kali-text-primary);">
                                            <span>github.com</span>
                                            <span class="badge bg-primary rounded-pill">5</span>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between align-items-center" style="background: var(--kali-card-bg); border: 1px solid var(--kali-border); color: var(--kali-text-primary);">
                                            <span>google.com</span>
                                            <span class="badge bg-primary rounded-pill">3</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-key fa-2x text-primary mb-2"></i>
                            <h3 class="fw-bold" id="totalPasswords">0</h3>
                            <p class="text-muted mb-0">Total Passwords</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-globe fa-2x text-info mb-2"></i>
                            <h3 class="fw-bold" id="uniqueSites">0</h3>
                            <p class="text-muted mb-0">Unique Sites</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <h3 class="fw-bold">Strong</h3>
                            <p class="text-muted mb-0">Security Level</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h3 class="fw-bold">Today</h3>
                            <p class="text-muted mb-0">Last Updated</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Stored Passwords</h5>
                        <div class="input-group" style="width: 300px;">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search passwords...">
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Website</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="passwordTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <p>No passwords stored yet. Add your first password!</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>
                    <span id="modalTitle">Add Password</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="passwordForm">
                <div class="modal-body">
                    <input type="hidden" id="passwordId">
                    <div class="mb-3">
                        <label for="websiteName" class="form-label">Website Name</label>
                        <input type="text" class="form-control" id="websiteName" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username/Email</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordInput" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleModalPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="generatePassword">
                                <i class="fas fa-dice"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save me-2"></i>Save Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let passwords = [];
let editingPasswordId = null;

// Load passwords on page load
$(document).ready(function() {
    loadPasswords();
});

function loadPasswords() {
    $.get('/api/passwords', function(data) {
        passwords = data;
        renderPasswords();
        updateStats();
    });
}

function renderPasswords(searchTerm = '') {
    const tbody = $('#passwordTableBody');
    const filtered = passwords.filter(pwd => 
        pwd.website_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        pwd.username.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filtered.length === 0) {
        tbody.html(`
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>${searchTerm ? 'No passwords found' : 'No passwords stored yet. Add your first password!'}</p>
                </td>
            </tr>
        `);
        return;
    }
    
    tbody.html(filtered.map(pwd => `
        <tr>
            <td>
                <i class="fas fa-globe me-2 text-primary"></i>
                ${pwd.website_name}
            </td>
            <td>${pwd.username}</td>
            <td>
                <span class="password-mask" data-password="${pwd.password}">
                    ${'•'.repeat(8)}
                </span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyPassword('${pwd.password}')" title="Copy">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="togglePasswordVisibility(this)" title="Show/Hide">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editPassword(${pwd.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePassword(${pwd.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join(''));
}

function updateStats() {
    $('#totalPasswords').text(passwords.length);
    const uniqueSites = new Set(passwords.map(p => p.website_name)).size;
    $('#uniqueSites').text(uniqueSites);
}

function copyPassword(password) {
    navigator.clipboard.writeText(password).then(() => {
        showToast('Password copied to clipboard!');
    });
}

function togglePasswordVisibility(button) {
    const icon = button.querySelector('i');
    const passwordSpan = button.closest('tr').querySelector('.password-mask');
    
    if (passwordSpan.textContent === '•'.repeat(8)) {
        passwordSpan.textContent = passwordSpan.dataset.password;
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passwordSpan.textContent = '•'.repeat(8);
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function editPassword(id) {
    const password = passwords.find(p => p.id === id);
    if (password) {
        editingPasswordId = id;
        $('#modalTitle').text('Edit Password');
        $('#passwordId').val(id);
        $('#websiteName').val(password.website_name);
        $('#username').val(password.username);
        $('#passwordInput').val(password.password);
        $('#passwordModal').modal('show');
    }
}

function deletePassword(id) {
    if (confirm('Are you sure you want to delete this password?')) {
        $.ajax({
            url: `/api/passwords/${id}`,
            method: 'DELETE',
            success: function() {
                loadPasswords();
                showToast('Password deleted successfully!');
            },
            error: function() {
                showToast('Error deleting password', 'error');
            }
        });
    }
}

function showToast(message, type = 'success') {
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('body').append(toast);
    toast.toast({ delay: 3000 }).toast('show');
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// Search functionality
$('#searchInput').on('input', function() {
    renderPasswords($(this).val());
});

// Password form submission
$('#passwordForm').on('submit', function(e) {
    e.preventDefault();
    
    const passwordData = {
        website_name: $('#websiteName').val(),
        username: $('#username').val(),
        password: $('#passwordInput').val()
    };
    
    const url = editingPasswordId ? `/api/passwords/${editingPasswordId}` : '/api/passwords';
    const method = editingPasswordId ? 'PUT' : 'POST';
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(passwordData),
        success: function() {
            $('#passwordModal').modal('hide');
            loadPasswords();
            showToast(`Password ${editingPasswordId ? 'updated' : 'added'} successfully!`);
            resetForm();
        },
        error: function() {
            showToast('Error saving password', 'error');
        }
    });
});

// Reset form when modal is hidden
$('#passwordModal').on('hidden.bs.modal', function() {
    resetForm();
});

function resetForm() {
    $('#passwordForm')[0].reset();
    $('#passwordId').val('');
    $('#modalTitle').text('Add Password');
    editingPasswordId = null;
}

// Toggle password visibility in modal
$('#toggleModalPassword').on('click', function() {
    const input = $('#passwordInput');
    const icon = $(this).find('i');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
});

// Generate random password
$('#generatePassword').on('click', function() {
    const length = 16;
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
    let password = '';
    
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    $('#passwordInput').val(password);
});
</script>
{% endblock %}
